name: Manage ResourceSyncConfig

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - update
          - delete
      name:
        description: 'Resource name'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        type: string
        default: 'dot-ai'
      mcp_endpoint:
        description: 'MCP endpoint URL'
        required: false
        type: string
        default: 'http://dot-ai.dot-ai.svc.cluster.local:3456/api/v1/resources/sync'
      auth_secret_name:
        description: 'Auth secret name'
        required: false
        type: string
        default: 'dot-ai-secrets'
      auth_secret_key:
        description: 'Auth secret key'
        required: false
        type: string
        default: 'auth-token'
      debounce_window_seconds:
        description: 'Debounce window in seconds'
        required: false
        type: number
        default: 10
      resync_interval_minutes:
        description: 'Resync interval in minutes'
        required: false
        type: number
        default: 60
      port_run_id:
        description: 'Port action run ID'
        required: true
        type: string

jobs:
  manage-resource:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report running status to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "RUNNING"
          logMessage: "${{ inputs.action }} ResourceSyncConfig ${{ inputs.name }} in namespace ${{ inputs.namespace }}"

      - name: Create/Update manifest
        if: inputs.action != 'delete'
        env:
          NAME: ${{ inputs.name }}
          NAMESPACE: ${{ inputs.namespace }}
          MCP_ENDPOINT: ${{ inputs.mcp_endpoint }}
          AUTH_SECRET_NAME: ${{ inputs.auth_secret_name }}
          AUTH_SECRET_KEY: ${{ inputs.auth_secret_key }}
          DEBOUNCE_WINDOW: ${{ inputs.debounce_window_seconds }}
          RESYNC_INTERVAL: ${{ inputs.resync_interval_minutes }}
        run: |
          mkdir -p apps

          cat > apps/resourcesyncconfig-$NAME.yaml << 'EOF'
          apiVersion: dot-ai.devopstoolkit.live/v1alpha1
          kind: ResourceSyncConfig
          metadata:
            name: PLACEHOLDER_NAME
            namespace: PLACEHOLDER_NAMESPACE
          spec:
            mcpEndpoint: PLACEHOLDER_ENDPOINT
            debounceWindowSeconds: 10
            resyncIntervalMinutes: 60
            mcpAuthSecretRef:
              name: PLACEHOLDER_SECRET_NAME
              key: PLACEHOLDER_SECRET_KEY
          EOF

          sed -i "s|PLACEHOLDER_NAME|$NAME|g" apps/resourcesyncconfig-$NAME.yaml
          sed -i "s|PLACEHOLDER_NAMESPACE|$NAMESPACE|g" apps/resourcesyncconfig-$NAME.yaml
          sed -i "s|PLACEHOLDER_ENDPOINT|$MCP_ENDPOINT|g" apps/resourcesyncconfig-$NAME.yaml
          sed -i "s|PLACEHOLDER_SECRET_NAME|$AUTH_SECRET_NAME|g" apps/resourcesyncconfig-$NAME.yaml
          sed -i "s|PLACEHOLDER_SECRET_KEY|$AUTH_SECRET_KEY|g" apps/resourcesyncconfig-$NAME.yaml

          yq -i ".spec.debounceWindowSeconds = $DEBOUNCE_WINDOW" apps/resourcesyncconfig-$NAME.yaml
          yq -i ".spec.resyncIntervalMinutes = $RESYNC_INTERVAL" apps/resourcesyncconfig-$NAME.yaml

      - name: Delete manifest
        if: inputs.action == 'delete'
        run: |
          rm -f apps/resourcesyncconfig-${{ inputs.name }}.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A apps/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "${{ inputs.action }} ResourceSyncConfig ${{ inputs.name }} in ${{ inputs.namespace }}"
            git push
          fi

      - name: Report success to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "ResourceSyncConfig ${{ inputs.name }} ${{ inputs.action }}d successfully. ArgoCD will sync changes."

      - name: Report failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to ${{ inputs.action }} ResourceSyncConfig ${{ inputs.name }}"
