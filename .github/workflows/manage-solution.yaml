name: Manage Solution

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - create
          - update
          - delete
      name:
        description: 'Solution name'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        type: string
        default: 'dot-ai'
      intent:
        description: 'Original user intent'
        required: false
        type: string
      rationale:
        description: 'Why this solution was deployed'
        required: false
        type: string
      documentation_url:
        description: 'Link to documentation'
        required: false
        type: string
      resources:
        description: 'JSON array of resources'
        required: false
        type: string
      port_run_id:
        description: 'Port action run ID'
        required: true
        type: string

jobs:
  manage-resource:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report running status to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "RUNNING"
          logMessage: "${{ inputs.action }} Solution ${{ inputs.name }} in namespace ${{ inputs.namespace }}"

      - name: Create/Update manifest
        if: inputs.action != 'delete'
        env:
          NAME: ${{ inputs.name }}
          NAMESPACE: ${{ inputs.namespace }}
          INTENT: ${{ inputs.intent }}
          RATIONALE: ${{ inputs.rationale }}
          DOC_URL: ${{ inputs.documentation_url }}
          RESOURCES: ${{ inputs.resources }}
        run: |
          mkdir -p apps

          cat > apps/solution-$NAME.yaml << 'EOF'
          apiVersion: dot-ai.devopstoolkit.live/v1alpha1
          kind: Solution
          metadata:
            name: PLACEHOLDER_NAME
            namespace: PLACEHOLDER_NAMESPACE
          spec:
            intent: ""
            context:
              createdBy: "port-action"
          EOF

          sed -i "s|PLACEHOLDER_NAME|$NAME|g" apps/solution-$NAME.yaml
          sed -i "s|PLACEHOLDER_NAMESPACE|$NAMESPACE|g" apps/solution-$NAME.yaml

          if [ -n "$INTENT" ]; then
            yq -i '.spec.intent = env(INTENT)' apps/solution-$NAME.yaml
          fi

          if [ -n "$RATIONALE" ]; then
            yq -i '.spec.context.rationale = env(RATIONALE)' apps/solution-$NAME.yaml
          fi

          if [ -n "$DOC_URL" ]; then
            yq -i '.spec.documentationURL = env(DOC_URL)' apps/solution-$NAME.yaml
          fi

          if [ -n "$RESOURCES" ] && [ "$RESOURCES" != "null" ] && [ "$RESOURCES" != "[]" ]; then
            echo "$RESOURCES" | yq -P -o=yaml > /tmp/resources.yaml
            yq -i '.spec.resources = load("/tmp/resources.yaml")' apps/solution-$NAME.yaml
          fi

      - name: Delete manifest
        if: inputs.action == 'delete'
        run: |
          rm -f apps/solution-${{ inputs.name }}.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A apps/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "${{ inputs.action }} Solution ${{ inputs.name }} in ${{ inputs.namespace }}"
            git push
          fi

      - name: Report success to Port
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: "Solution ${{ inputs.name }} ${{ inputs.action }}d successfully. ArgoCD will sync changes."

      - name: Report failure to Port
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to ${{ inputs.action }} Solution ${{ inputs.name }}"
